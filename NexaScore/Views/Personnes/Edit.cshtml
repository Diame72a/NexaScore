@model Projet.Models.Personne
@{
    ViewData["Title"] = "Éditer le profil";


    string defaultBanner = "https://images.unsplash.com/photo-1579546929518-9e396f3cc809?auto=format&fit=crop&w=1000&q=80";
    string currentBanner = !string.IsNullOrEmpty(Model.ImageBannierePath) ? Model.ImageBannierePath : defaultBanner;
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>

    .file-upload-wrapper {
        position: relative;
        overflow: hidden;
        border-radius: 10px;
        transition: all 0.3s;
    }

        .file-upload-wrapper:hover .upload-overlay {
            opacity: 1;
        }

    .upload-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s;
        cursor: pointer;
    }

    .hidden-file-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
        z-index: 10;
    }


    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    }

    .hover-red:hover {
        color: #dc3545 !important;
    }
</style>

<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-white border shadow-sm rounded-circle me-3"><i class="fas fa-arrow-left"></i></a>
            <div>
                <h4 class="fw-bold mb-0 text-dark">Édition du Profil</h4>
                <span class="text-muted small">@Model.Prenom @Model.Nom</span>
            </div>
        </div>
        <button type="submit" form="mainForm" class="btn btn-primary shadow-sm rounded-pill px-4 fw-bold">
            <i class="fas fa-save me-2"></i>Enregistrer
        </button>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success border-0 shadow-sm rounded-4 mb-4 px-4 d-flex align-items-center">
            <i class="fas fa-check-circle fa-lg me-3"></i>
            <div><strong>Succès !</strong> @TempData["SuccessMessage"]</div>
        </div>
    }

    <form asp-action="Edit" enctype="multipart/form-data" id="mainForm">
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="ImageProfilPath" />
        <input type="hidden" asp-for="ImageBannierePath" />
        <input type="hidden" asp-for="CvPath" />
        <input type="hidden" asp-for="CvNomFichier" />

        <div class="row g-4">

            <div class="col-lg-4">

                <div class="card border-0 shadow-sm rounded-4 mb-4 text-center">
                    <div class="card-body p-4">
                        <div class="position-relative d-inline-block">
                            <div style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; border: 4px solid #f8f9fa;" class="shadow-sm mx-auto mb-3 file-upload-wrapper">
                                @if (!string.IsNullOrEmpty(Model.ImageProfilPath))
                                {
                                    <img src="@Model.ImageProfilPath" id="previewProfil" class="w-100 h-100 object-fit-cover" />
                                }
                                else
                                {
                                    <div class="w-100 h-100 d-flex align-items-center justify-content-center bg-light text-primary fw-bold fs-3" id="previewProfilPlaceholder">
                                        @Model.Prenom.Substring(0, 1)@Model.Nom.Substring(0, 1)
                                    </div>
                                    <img src="" id="previewProfil" class="w-100 h-100 object-fit-cover d-none" />
                                }
                                <div class="upload-overlay">
                                    <i class="fas fa-camera text-white"></i>
                                    <input type="file" name="fileProfil" class="hidden-file-input" accept="image/*" onchange="previewImage(this, 'previewProfil', 'previewProfilPlaceholder')" />
                                </div>
                            </div>
                        </div>
                        <h6 class="fw-bold text-dark">@Model.Prenom @Model.Nom</h6>
                        <p class="text-muted small mb-0">Cliquez sur la photo pour modifier</p>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-header bg-white py-3 px-4 fw-bold text-primary border-bottom">
                        <i class="fas fa-id-card me-2"></i>Coordonnées
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label asp-for="Prenom" class="form-label small fw-bold text-muted">PRÉNOM</label>
                                <input asp-for="Prenom" class="form-control bg-light border-0" />
                            </div>
                            <div class="col-6">
                                <label asp-for="Nom" class="form-label small fw-bold text-muted">NOM</label>
                                <input asp-for="Nom" class="form-control bg-light border-0" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Email" class="form-label small fw-bold text-muted">EMAIL</label>
                            <input asp-for="Email" class="form-control bg-light border-0" />
                        </div>

                        <div class="mb-3">
                            <label asp-for="Telephone" class="form-label small fw-bold text-muted">TÉLÉPHONE</label>
                            <input asp-for="Telephone" class="form-control bg-light border-0" placeholder="06..." />
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-8 position-relative">
                                <label asp-for="Ville" class="form-label small fw-bold text-muted">VILLE</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0 ps-2"><i class="fas fa-search small text-muted"></i></span>
                                    <input asp-for="Ville" id="inputVille" class="form-control bg-light border-0" autocomplete="off" />
                                </div>
                                <ul id="suggestionsVille" class="dropdown-menu w-100 shadow border-0" style="display:none; max-height: 200px; overflow-y: auto; z-index: 1000;"></ul>
                            </div>
                            <div class="col-4">
                                <label asp-for="CodePostal" class="form-label small fw-bold text-muted">CP</label>
                                <input asp-for="CodePostal" id="inputCp" class="form-control bg-light border-0" readonly />
                            </div>
                        </div>

                        <div id="map" style="height: 180px; width: 100%; border-radius: 8px;" class="mb-3 border"></div>

                        <div class="mb-0">
                            <label asp-for="DateNaissance" class="form-label small fw-bold text-muted">DATE NAISSANCE</label>
                            <input asp-for="DateNaissance" type="date" class="form-control bg-light border-0"
                                   value="@Model.DateNaissance.ToString("yyyy-MM-dd")" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">

                <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
                    <div class="position-relative file-upload-wrapper" style="height: 150px;">
                        <img src="@currentBanner" id="previewBanniere" class="w-100 h-100 object-fit-cover" />
                        <div class="upload-overlay flex-column">
                            <i class="fas fa-image fa-2x text-white mb-2"></i>
                            <span class="text-white fw-bold small">Changer la bannière</span>
                            <input type="file" name="fileBanniere" class="hidden-file-input" accept="image/*" onchange="previewImage(this, 'previewBanniere')" />
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-white py-3 px-4 fw-bold text-success border-bottom">
                        <i class="fas fa-user-tie me-2"></i>Profil Professionnel
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3 mb-3">
                            <div class="col-md-8">
                                <label asp-for="TitreJobActuel" class="form-label small fw-bold text-muted">POSTE ACTUEL</label>
                                <input asp-for="TitreJobActuel" class="form-control bg-light border-0" placeholder="Ex: Développeur Fullstack" />
                            </div>
                            <div class="col-md-4">
                                <label asp-for="AnneesExperienceTotal" class="form-label small fw-bold text-muted">EXPÉRIENCE (ANS)</label>
                                <input asp-for="AnneesExperienceTotal" type="number" min="0" class="form-control bg-light border-0" />
                            </div>
                        </div>

                        <div class="mb-4">
                            <label asp-for="Description" class="form-label small fw-bold text-muted">BIO / RÉSUMÉ</label>
                            <textarea asp-for="Description" class="form-control bg-light border-0" rows="4" placeholder="Présentez le candidat..."></textarea>
                        </div>

                        <div class="p-3 border border-dashed rounded-3 bg-light position-relative file-upload-wrapper">
                            <div class="d-flex align-items-center">
                                <div class="bg-white p-3 rounded-circle shadow-sm me-3 text-danger">
                                    <i class="fas fa-file-pdf fa-lg"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="fw-bold text-dark mb-0">Curriculum Vitae</h6>
                                    <p class="text-muted small mb-0" id="cvFileName">
                                        @(string.IsNullOrEmpty(Model.CvNomFichier) ? "Aucun fichier sélectionné" : Model.CvNomFichier)
                                    </p>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-dark rounded-pill position-relative z-0">Parcourir...</button>
                                <input type="file" name="fileCv" class="hidden-file-input" accept=".pdf,.doc,.docx"
                                       onchange="document.getElementById('cvFileName').innerText = this.files[0].name" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-white py-3 px-4 d-flex justify-content-between align-items-center border-bottom">
                        <span class="fw-bold text-dark"><i class="fas fa-layer-group me-2"></i>Compétences</span>
                        <button type="button" class="btn btn-sm btn-primary rounded-pill px-3 fw-bold shadow-sm" onclick="loadBulkModal(@Model.Id)">
                            <i class="fas fa-plus me-1"></i> Gérer
                        </button>
                    </div>
                    <div class="card-body p-4 bg-light bg-opacity-25">
                        @if (Model.CompetenceAcquises != null && Model.CompetenceAcquises.Any())
                        {
                            <div class="d-flex flex-wrap gap-2">
                                @foreach (var item in Model.CompetenceAcquises.OrderByDescending(x => x.Niveau))
                                {
                                    <div class="bg-white px-3 py-2 rounded-3 border shadow-sm d-flex align-items-center">
                                        <span class="fw-bold me-2 text-dark">@item.Competence?.Nom</span>
                                        <span class="badge bg-primary bg-opacity-10 text-dark border fw-normal" style="font-size: 0.7rem;">Nv. @item.Niveau</span>
                                        <form asp-action="SupprimerCompetence" method="post" class="d-inline ms-2">
                                            <input type="hidden" name="id" value="@item.Id" />
                                            <input type="hidden" name="source" value="Edit" />
                                            <button type="submit" class="btn btn-link p-0 text-muted hover-red"><i class="fas fa-times-circle"></i></button>
                                        </form>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center text-muted py-3 small">Aucune compétence technique.</div>
                        }
                    </div>
                </div>

            </div>
        </div>
    </form>
</div>

<div class="modal fade" id="modalBulkAdd" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header text-white border-0" style="background: linear-gradient(135deg, #2af598 0%, #009efd 100%);">
                <h5 class="modal-title fw-bold">Gestion des compétences</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div id="modalBulkContent"><div class="p-5 text-center"><div class="spinner-border text-primary"></div></div></div>
        </div>
    </div>
</div>

<script>

    function previewImage(input, imgId, placeholderId) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var img = document.getElementById(imgId);
                img.src = e.target.result;
                img.classList.remove('d-none');
                if(placeholderId) document.getElementById(placeholderId).classList.add('d-none');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }


    function loadBulkModal(personneId) {
        var myModal = new bootstrap.Modal(document.getElementById('modalBulkAdd'));
        myModal.show();
        fetch('/Personnes/AjouterPlusieurs/' + personneId)
            .then(r => r.text())
            .then(h => document.getElementById('modalBulkContent').innerHTML = h);
    }


    var mapInstance;
    var markerInstance;

    document.addEventListener("DOMContentLoaded", function() {


        var mapElement = document.getElementById('map');
        if (mapElement) {
            mapInstance = L.map('map', { zoomControl: false }).setView([46.603354, 1.888334], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(mapInstance);


            var villeInit = "@Html.Raw(Model.Ville ?? "")";
            var cpInit = "@Html.Raw(Model.CodePostal ?? "")";
            if(villeInit) {
                searchCityCoordinates(villeInit + " " + cpInit);
            }
        }


        const inputVille = document.getElementById('inputVille');
        const suggestionsList = document.getElementById('suggestionsVille');
        const inputCp = document.getElementById('inputCp');

        if(inputVille) {
            inputVille.addEventListener('input', function() {
                const query = this.value;
                if (query.length < 3) { if(suggestionsList) suggestionsList.style.display = 'none'; return; }

                fetch(`https://geo.api.gouv.fr/communes?nom=${query}&fields=nom,codesPostaux,centre&boost=population&limit=5`)
                    .then(response => response.json())
                    .then(data => {
                        if(suggestionsList) {
                            suggestionsList.innerHTML = '';
                            if (data.length > 0) {
                                suggestionsList.style.display = 'block';
                                data.forEach(ville => {
                                    const item = document.createElement('li');
                                    const lat = ville.centre.coordinates[1];
                                    const lon = ville.centre.coordinates[0];

                                    item.innerHTML = `<a class="dropdown-item py-2 border-bottom" href="#" onclick="selectVille(event, '${ville.nom}', '${ville.codesPostaux[0]}', ${lat}, ${lon})">
                                                        <div class="d-flex justify-content-between">
                                                            <span>${ville.nom}</span>
                                                            <span class="text-muted small">${ville.codesPostaux[0]}</span>
                                                        </div>
                                                      </a>`;
                                    suggestionsList.appendChild(item);
                                });
                            } else { suggestionsList.style.display = 'none'; }
                        }
                    });
            });
        }

        document.addEventListener('click', function(e) { if (e.target !== inputVille && suggestionsList) suggestionsList.style.display = 'none'; });
    });

    function selectVille(e, nom, cp, lat, lon) {
        e.preventDefault();
        document.getElementById('inputVille').value = nom;
        document.getElementById('inputCp').value = cp;
        document.getElementById('suggestionsVille').style.display = 'none';
        updateMap(lat, lon);
    }

    function updateMap(lat, lon) {
        if(mapInstance) {
            mapInstance.setView([lat, lon], 13);
            if(markerInstance) markerInstance.setLatLng([lat, lon]);
            else markerInstance = L.marker([lat, lon]).addTo(mapInstance);
        }
    }

    function searchCityCoordinates(query) {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
            .then(r => r.json())
            .then(d => {
                if (d && d.length > 0) {
                    updateMap(d[0].lat, d[0].lon);
                }
            });
    }
</script>